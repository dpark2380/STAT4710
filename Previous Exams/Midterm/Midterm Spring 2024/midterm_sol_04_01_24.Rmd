---
title: 'Midterm: Chicago Housing Case Study'
author: "WRITE YOUR NAME HERE"
date: "April 1, 2024"
output:
  html_document:
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
    number_sections: no
urlcolor: blue
---

```{r Setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = T, fig.width=8, fig.height=4, warning = F, message = F)
options(scipen = 999, digits = 3)  # controls base R output

# Package setup
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, glmnet, car)
```

# Instruction

**The midterm will be conducted from 7:00 PM to 9:00 PM. The submission will be closed sharp at 9:15 PM.** 


**Instruction:** This midterm requires you to use R. It is completely open book/notes/internet. However any versions of ChatGPT or alike are strictly prohibitive. Write your answers using this .rmd file and knitr it into the html file. Show your codes, plots or R-output when needed. You always need to show your code with `echo = TRUE` which is the default setup for this file. If you have trouble formatting the plots, don't worry about it. We are not looking for pretty solutions, rather to see if you are able to make sense out of the data.  Make sure the compiled html (and/or pdf) file shows your answers completely and that they are not cut-off. Throughout the exam, you do not need to use any LaTeX or mathematical equations. **Whenever we ask for test at some significant level, assume all the model assumptions are satisfied.**

**All the answers should be clearly supported by relevant R code or based on the R output. There are many ways to provide answers.**  

There are 4 questions with various parts:

- **Question 1: 5 parts**
- **Question 2: 4 parts**
- **Question 3: 2 parts**
- **Question 4: 2 parts**

**DO NOT spend too much time on a single question. Come back to where you stuck after you have tried all the questions.**

**Files needed for the midterm:** 

- `any_folder/midterm.Rmd`
- `any_folder/midterm_24.csv`


**Electronic Submission:** Two files needed: your `.rmd` file and a compiled html file. If you have trouble submitting the files to Canvas, email them to lzhao@wharton.upenn.edu, dongwooo@wharton.upenn.edu and neil.fasching@asc.upenn.edu.

**Label them with your full name.** In the `Assignments` section, go to the `Midterm` assignment and upload your completed files.

**The submission folder will be closed sharp at 9:15PM**. 

**On Site Help:** We will answer any clarification questions. We may also help out with some minor code issues. We will, however, not provide any answers as to what functions to use for example. 

**Raise your hand** if you want to talk to one of us.
   
In case of emergency, here is Linda's cell: 6106590187 (text or call her)

# Background

**The Dataset:** For the midterm, we will continue using the Chicago Housing dataset. Hailing from the [Cook County Assessor](https://gitlab.com/groups/ccao-data-science---modeling/-/wikis/SOPs/Open%20Data), where they have compiled and integrated collection of information, meticulously gathered from a variety of distinct sources to offer  an extensive array of individual housing attributes. Beyond the mere physical aspects, this dataset uniquely incorporates social dimensions through spatial information or proximity variables as well as demographic variables by census tract, amongst other fascinating properties. Notice we have also included a categorical variable `over_500K`: `1` indicates a house was sold at a price higher than `500K` and otherwise it is a `0`. To be specific: 

- `over_500K = 1` if the `log_price` is greater than or equal to `log(5e+5)`.
- `over_500K = 0` if the `log_price` is smaller than `log(5e+5)`.

|Feature|Description|
|------------------|----------------------------------------------|
|`log_price`| Log sale price |
|`neighborhood`|neighborhood: A few areas in the Cook County |
|`beds`|Bedrooms: Number of bedrooms in the building |
|`bldg`| Building square feet |
|`fbath`|Full Baths: Number of full bathrooms, defined as having a bath or shower. If this value is missing, the default value is set to 1. |
|`hbath`|Half baths: Number of half baths, defined as bathrooms without a shower or bathtub. |
|`land`| Lot/land square feet|
|`rooms`|Rooms: Number of total rooms in the building (excluding baths). Not to be confused with bedrooms. |
|`lake_michigan_dist_ft` | Distance in feet to the Lake Michigan coastline.|
|`nearest_cta_stop_dist_ft`| Distance in feet to the nearest CTA (subway) stop. |
|`percent_employment_unemployed`| Percent of neighborhood unemployed |
|`percent_age_children`| Percent of neighborhood children age |
|`percent_education_high_school`| Percent of neighborhood in high school |
|`percent_income_below_poverty_level`| Percent of neighborhood below poverty line |
|`over_500K`| If a house is over \$500k, `1: yes, 0: no` | 

**There are two main goals for this case study:** 

1. Develop a regression model to predict the logarithmic value of house prices in a few neighborhoods of Chicago area. This model aims to capture the pricing trends and provide an accurate estimation of housing values in these areas. (We focus on this part of the analyses.)

2. Create a binary classification model to distinguish between houses valued at over \$500K dollars and those valued at under \$500K dollars. The goal is to effectively categorize properties into these two distinct price brackets.

To make our case study here simple and manageable in a timely fashion, we have assembled a subset of data called: `midterm_24.csv`. It includes all the variables listed above plus a few additional variables. The name of each variable should be self-explanatory.

```{r read data}
sales <- read.csv("midterm_24.csv")
sales$neighborhood <- as.factor(sales$neighborhood)
```


# Question 1. EDA

## Question 1-1.

We first take a look at the data: 

**i.** How many houses and how many variables are included in the data set?

**ii.** Which areas in the Cook County are included in the data? 

**Please write your answer starting from here:**

```{r quick look}
dim(sales)
levels(sales$neighborhood)
```








## Question 1-2.

Report the minimum, median, mean and maximum of log price (`log_price`), year built (`yrblt`), number of bedrooms (`beds`) and number of full bathrooms (`fbath`), respectively.

**i.**  What is the most expensive housing price in this data set? You may recover the actual price by using `exp(log_price)`.

**ii.** Which year at which the oldest house was built?

**Please write your answer starting from here:**
```{r}
sales %>% select(log_price, yrblt, beds, fbath) %>% summary()
sales %>% select(log_price) %>% max() %>% exp()
sales %>% select(yrblt) %>% min()
```









## Question 1-3.

Create back-to-back boxplots of `log_price` versus  `neighborhood`. Use no more than three sentences to describe the comparison of the `log_price` by `neighborhood`.

**Please write your answer starting from here:**
```{r}
ggplot(sales, aes(x = neighborhood, y = log_price)) +
    geom_boxplot()
``` 







## Question 1-4.

Report the ratio of houses over \$500K (i.e. `over_500K = 1`) in percentage for each `neighborhood`.

**Please write your answer starting from here:**
```{r}
sales %>% group_by(neighborhood) %>% summarise(over_500K_ratio = mean(over_500K)*100)
```








## Question 1-5.

To investigate how `lake_michigan_dist_ft` affect `over_500K`, please draw histogram of `lake_michigan_dist_ft` (distance in feet to the Lake Michigan coastline) for each `over_500k`. Overlay two histograms with different colors in one plot. Use no more than three sentences to describe the comparison of the `lake_michigan_dist_ft` by `over_500K`.

**Hint: make sure that `over_500K` is a factor. **

If you can't get the desired histograms, proceed with your own plot to answer the question of how `lake_michigan_dist_ft` relates `over_500K`.

**Please write your answer starting from here:**
```{r}
ggplot(sales, aes(x = lake_michigan_dist_ft, fill= as.factor(over_500K))) +
    geom_histogram(position = position_dodge())
```










# Question 2. `fit1:` A Linear Model for `log_price`

In the following analyses, we focus on the effect of `beds`, `fbath`, `bldg`, `lake_michigan_dist_ft` and `neighborhood` on `log_price`. 


## Question 2-1.

Run a regression of `log_price` vs. `beds`, `fbath`, `bldg`, `lake_michigan_dist_ft` and  `neighborhood` without interactions as `fit1`. Report the summary of `fit1`. 

**i.** In this model is `lake_michigan_dist_ft` a useful variable at .01 level?  

**ii.**  Is the effect of `lake_michigan_dist_ft` on the `log_price` same across from different neighborhood? Use no more than three sentences to interpret its effect on the `log_price`.

**iii.** What is the effect of `beds` on `log_price`? 

**iv.** On average, which neighborhood has the lowest `log_price` controlling for all other variables?

**Please write your answer starting from here:** 
```{r}
fit1 <- lm(log_price ~ beds + fbath + bldg + lake_michigan_dist_ft + neighborhood, data = sales)
summary(fit1)
```








## Question 2-2.

Are the housing prices same on average across from the three neighborhood? Show your test at .01 significant level.  

**Please write your answer starting from here:**
```{r}
Anova(fit1)
```











## Question 2-3.

Using the `fit1` model, predict the `log_price` of a house with 4 bedrooms (`beds = 4`), 3 full bathrooms (`fbath = 3`), 1,500 square feet building size (`bldg = 1500`), 20,000 feet away from the Lake Michigan coastline (`lake_michigan_dist_ft = 20000`), and located in the `neighborhood` of `JEFFERSON PARK`. In addition to the prediction, provide the 95\% prediction interval.

You may use the following chunk of codes:
```{r}
house <- tibble(beds = 4, fbath = 3, bldg = 1500, lake_michigan_dist_ft = 20000, neighborhood = "JEFFERSON PARK")
```

**Please write your answer starting from here:**
```{r}
predict(fit1, house, interval = "predict", level = 0.95)
```
    








## Question 2-4.

To check the model assumptions are met, draw the residual plot of residuals versus fitted values. Do you think the linear model assumptions are met? Why or why not? 

**Please write your answer starting from here:**
```{r}
plot(fit1, 1, pch=16)
```







# Question 3. `fit2:` Relaxed LASSO 

Use LASSO to pick up a few variables among the entire data. We require that `neighborhood` is forced in all the LASSO models as we know that LOCATION is an important factor affecting the housing prices. 

## Question 3-1 

Get the varialbes from LASSO. Here are the specifications to get the LASSO variables


`fit_lasso_cv`:  Run LASSO with the following settings to get the same results. 

* Use `set.seed(1)` to control the cross-validation
* Use 15-fold cross validations
* Force `neighborhood` all the LASSO models 
* Pick up the variables using `s = exp(-3.5)`
* Collect the LASSO variables
    

 
**i.** Show the LASSO plot
 
**ii.** How many variables are selected in addition to `neighborhood`? 
 
**iii.** Gather variable names selected by LASSO and `neighborhoo` as lasso_selected <- c("neighborhood",... )
 
To help out we provide the following setting up chunk to get `fit_lasso_cv`
```{r results='hold'}
sales_temp <- sales %>% select(-over_500K)
# names(sales_temp)
Y <- as.matrix(sales_temp[, 'log_price']) # extract Y
X <- model.matrix(log_price ~ ., data = sales_temp)[, -1]
force_in_indicator <- c(rep(0, 2), rep(1, ncol(X)-2))
set.seed(1)
```

 
**Please write your answer starting from here:**
 
```{r results='hold'}
sales_temp <- sales %>% select(-over_500K)
# names(sales_temp)
Y <- as.matrix(sales_temp[, 'log_price']) # extract Y
X <- model.matrix(log_price ~ ., data = sales_temp)[, -1]
force_in_indicator <- c(rep(0, 2), rep(1, ncol(X)-2))
set.seed(1)
fit_lasso_cv <- cv.glmnet(X, Y, alpha = 1, nfolds = 15, intercept = TRUE,
                          penalty.factor = force_in_indicator)
plot(fit_lasso_cv)
coef <- coef(fit_lasso_cv, s = exp(-3.5))
coef <- coef[which(coef != 0), ]
lasso_selected <- c("neighborhood", names(coef)[-c(1:3)])
lasso_selected  # variables selected by LASSO
```






## Question 3-2 

For consistency, we assume that the following variables are selected by LASSO.
```{r}
lasso_selected <- c("neighborhood", "yrblt", "fbath", "tax_bill_amount_total", "bldg", "land", "percent_employment_unemployed")
```

Get a relaxed LASSO `fit2`. Report the summary of `fit2` using all the variables selected from LASSO and `neighborhood`.  

**i.**  Is `neighborhood` a significant variable in fit2 at .01 level? 

**ii.**  Controlling for all other variables which neighborhood has the lowest housing price on average? 

**iii.** Use no more than three sentences to comment on how the features are selected and how each variable is related to housing price and in what way.

**Please write your answer starting from here:**

```{r}
sales1 <- sales_temp[,c("log_price", lasso_selected)] # you may find this useful
fit2 <- lm(log_price ~., sales1)
Anova(fit2)
summary(fit2)
```







# Question 4. `fit3:` Classification Model for `over_500K`

We will focus on the classification problem for the binary response variable `over_500K`.

## Question 4-1.

Run a logistic regression of `over_500K` vs. `beds`, `fbath`, `bldg`, `lake_michigan_dist_ft` and `neighborhood` with no interactions.   Save the result as `fit3`. Report `summary(fit3)`. 

**i.** Is `lake_michigan_dist_ft` a significant variable in this model at .01 level? 

**ii.** How to interpret the coefficient of `lake_michigan_dist_ft` in this model? 

**Please write your answer starting from here:**
```{r}
fit3 <- glm(over_500K ~ beds + fbath + bldg + lake_michigan_dist_ft + neighborhood,  data = sales, family = 'binomial')
summary(fit3)
```









## Question 4-2.

Consider the house presented earlier with 4 bedrooms (`beds = 4`), 3 full bathrooms (`fbath = 3`), 1,500 square feet building size (`bldg = 1500`), 20,000 feet away from the Lake Michigan coastline (`lake_michigan_dist_ft = 20000`), and located in the `neighborhood` of `JEFFERSON PARK`. Based on the model `fit3`:

**i.**  What is the estimated probability of the house being sold over \$500K? 

**ii.**  Would  this house predicted to be over \$500K? Suppose that the cost of misclassifying `1` to `0` is 3 times of that of misclassifying `0` to `1` and no loss with correct predictions. We use the optimal threshold which minimizes WMCE under this assumption.

You may use the object `house` defined in Question 2-3.

**Please write your answer starting from here:**
```{r}
predict(fit3, house, type = "response") 
threshold <- (1/3)/(1+1/3)
```










# END OF THE EXAM