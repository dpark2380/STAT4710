---
title: "COVID-19 Case Study Midterm"
author: "Alex Coble"
date: "6:00-9:00PM (ET), 03/29/2021"
output:
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: no
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    number_sections: no
    toc_depth: '4'
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
---

```{r Setup, include=FALSE, results='hide', warning=FALSE}
knitr::opts_chunk$set(echo = T, fig.width=8, fig.height=4)
options(scipen = 0, digits = 3)  # controls base R output

# Package setup
if(!require("pacman")) install.packages("pacman")

# add packages if needed
pacman::p_load(tidyverse, dplyr, ggplot2, data.table, lubridate, glmnet, car)
```

# Instruction

We have designed a two hour exam as planned. Due to virtual environment, we will allow anyone to stay for a three hour period. All the teaching team will be available from 6:00 - 9:00 PM.  The submission will be closed sharp at 9:00PM. 

Midterm Zoom link: https://upenn.zoom.us/j/92401814411?pwd=Q1E3cnBWOWpHNE5zelZXZWRCRHVJQT09

**Instruction:** This midterm requires you to use R. It is completely open book/notes/internet. Write your answers using .rmd format and knitr it into one of the html/pdf/docx format. Show your codes, plots or R-output when needed. You can use `echo = TRUE` to show your codes which is the default setup for this file. If you have trouble formatting the plots, don't worry about it. We are not looking for pretty solutions, rather to see if you are able to make sense out of the data using R. Make sure the compiled pdf/html/docx (only one of them) shows your answers completely and that they are not cut-off. Throughout the exam, you do not need to use any LaTeX or mathematical equations. **Whenever we ask for test at some level, assume all the model assumptions are satisfied.**

**All the answers should be clearly supported by relevant R code or based on the R output**. 

There are 4 questions with various parts:

- **Question 1: 3 parts**
- **Question 2: 1 part**
- **Question 3: 5 parts**
- **Question 4: 5 parts**

**Data needed for the Midterm:** `/canvas/Files/Exams/Midterm/Midterm Spring 2021/data/covid_county_midterm.csv` 

**Electronic Submission:** Two files needed: your `.rmd` file and a compiled file (either a pdf/html/docx). **Label them with your full name.** In the `Assignments` section, go to the `Midterm` assignment and upload your completed files. If you have trouble to submit the files to canvas email them to lzhao@wharton.upenn.edu and junhui@wharton.upenn.edu. 

**The submission folder will be closed sharp at 9:00PM**. 

**On Site Help:** 

- Any clarification questions should be posted in the chat to the class.

- If you want to talk to one of us you may do the following (for example, if you are stuck somewhere....We will try to debug for you.)

    - 5-6 break-out rooms are created
    - **Raise your hand** (We will send you to an available break-out room one at a time.)
    - Send a private chat to one of us 
    - Email to the entire team
   
- Our emails:

lzhao@wharton.upenn.edu 
junhui@wharton.upenn.edu	
cyfang@wharton.upenn.edu	
farnik@sas.upenn.edu	
niparkes@wharton.upenn.edu	
rosesamk@sas.upenn.edu	
    
Linda's cell: 6106590187

# Background

The outbreak of the novel Corona virus disease 2019 (COVID-19) [was declared a public health emergency of international concern by the World Health Organization (WHO) on January 30, 2020](https://www.who.int/dg/speeches/detail/who-director-general-s-statement-on-ihr-emergency-committee-on-novel-coronavirus-(2019-ncov)). Upwards of [112 million cases have been confirmed worldwide, with nearly 2.5 million associated deaths](https://covid19.who.int/). Within the US alone, there have been [over 500,000 deaths and upwards of 28 million cases reported](https://covid.cdc.gov/covid-data-tracker/#trends_dailytrendscases). Governments around the world have implemented and suggested a number of policies to lessen the spread of the pandemic, including mask-wearing requirements, travel restrictions, business and school closures, and even stay-at-home orders. The global pandemic has impacted the lives of individuals in countless ways, and though many countries have begun vaccinating individuals, the long-term impact of the virus remains unclear.

The impact of COVID-19 on a given segment of the population appears to vary drastically based on the socioeconomic characteristics of the segment. In particular, differing rates of infection and fatalities have been reported among different [racial groups](https://www.cdc.gov/coronavirus/2019-ncov/covid-data/investigations-discovery/hospitalization-death-by-race-ethnicity.html), [age groups](https://www.cdc.gov/coronavirus/2019-ncov/covid-data/investigations-discovery/hospitalization-death-by-age.html), and [socioeconomic groups](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7221360/). One of the most important metrics for determining the impact of the pandemic is the death rate, which is the proportion of people within the total population that die due to the the disease. 

There are two main goals for this case study. 

1. Number of deaths vary drastically across State. We want to find out how State relate to the death rate.

2. Covid seems to target elder people's lives. Is there evidence in our data to show that proportion of elder people indeed relates to the death at county level. 

# 1. Data preparation {-}

To make our case study here simple and manageable in a time fashion, we have assembled a subset of data called: `covid_county_midterm.csv`. It collects county level death rate, labeled as `log_death_rate`, as well as a subset of demographic information based on the two cleaned data:

* **covid_county.csv**: County-level socialeconomic information that combines the above-mentioned 4 datasets: Income (Poverty level and household income), Jobs (Employment type, rate, and change), People (Population size, density, education level, race, age, household size, and migration rates), County Classifications
* **covid_rates.csv**: Daily cumulative numbers on infection and fatality for each county

## Death rate

What is a good way to measure Covid death rate? There are quite a number of counties with a very low or none number of deaths. We have created a new measurement of death rate as follows: 

- The total number of death for each county is gathered by November 1st, 2020

- The death rate is calculated as the total number of deaths plus 1 in the county divided by the total population of the county plus 2. We then apply the function log to get the `log_death_rate`. 

## Read data

We are ready to read the data `covid_county_midterm.csv` into R. 

**To simplify the analyses further, we created a subset here called `covid_county_sub` for us to use in the entire case study.** 

```{r read data }
covid_county <- fread("covid_county_midterm.csv")

covid_county_sub <- covid_county %>%
  select(log_death_rate, State, Deep_Pov_All, PovertyAllAgesPct, PerCapitaInc, UnempRate2019, PctEmpFIRE, PctEmpConstruction, PctEmpTrans, PctEmpMining, PctEmpTrade, PctEmpInformation, PctEmpAgriculture, PctEmpManufacturing, PctEmpServices, PopDensity2010, OwnHomePct, Age65AndOlderPct2010, TotalPop25Plus, Under18Pct2010, Ed2HSDiplomaOnlyPct, Ed3SomeCollegePct, Ed4AssocDegreePct, Ed5CollegePlusPct, ForeignBornPct, Net_International_Migration_Rate_2010_2019, NetMigrationRate1019, NaturalChangeRate1019, TotalPopEst2019, WhiteNonHispanicPct2010, NativeAmericanNonHispanicPct2010, BlackNonHispanicPct2010, AsianNonHispanicPct2010, HispanicPct2010, Type_2015_Update, RuralUrbanContinuumCode2013, UrbanInfluenceCode2013, Perpov_1980_0711, HiCreativeClass2000, HiAmenity, Retirement_Destination_2015_Update)
```

# 2. EDA

During the course of pandemic, we have witnessed that many policies are carried out at state level. For example when to reopen after the March lock-down. To see the variability of death rates among states we suggest you to go through the following EDA process.

## Question 1: (3 parts) 

**1)** Create the average `log_death_rate` by State. Show the histogram of the average `log_death_rate` by State. Use no more than three sentences to summarize the variability of the average `log_death_rate` by State.

```{r}
#Creating the average log death rate by state:
covid_state = covid_county_sub %>% 
  group_by(State) %>%
  summarize(avg_log_death_rate = mean(log_death_rate))

#Examining the data variabililty:
summary(covid_state)
sd(covid_state$avg_log_death_rate)

#Plotting a histogram:
covid_state %>% 
  ggplot(aes(x = avg_log_death_rate))+
  geom_histogram(fill = "blue") +
  ggtitle("Average Log Death Rate by State")+
  xlab("Average Log Death Rate")+
  ylab("Frequency")
```
**Response**:  As displayed in the summary statistics, the average log death rate for each state ranges from -9.55 to -6.47 and has a mean and median of -7.80 and -7.81, respectively.  However, as you can see in the histogram, the majority of states seem to have log death rates between around -8.6 and -7.  The standard deviation of the average log death rates is 0.695.

**2)**  To see within `State` county level variability, make box-plots `log_death_rate` by `State`. Use no more than two lines to describe the variability of `log_death_rate` by `State`.

```{r}
covid_county_sub %>% 
  ggplot(aes(x = State,y = log_death_rate,group=State))+
  geom_boxplot()+
  ggtitle("Within State Variability of Log Death Rate")+
  ylab("Log Death Rate")
```
**Response**: From the boxplots above, you can see that the log death rate varies considerably between counties within each state as well between states.  Some states have almost no within state variability (i.e. Delaware) while other states have seemingly huge variability (i.e. New York).

**3)** What is the state with the highest average `log_death_rate`, and what is this rate?
```{r}
covid_state %>% 
  arrange(-avg_log_death_rate)
```
**Response**: New Jersey has the highest average log death rate.  New Jersey's average log death rate is -6.47.

# 3. Analyses

In the following analyses, we try to find out factors related to `log_death_rate`. 

## 3.1 fit1: `Age`  and  `log_death_rate`

There are a number of studies indicating covid claimed most of elder lives. Let us start with a simple regression of `log_death_rate` vs. `Age65AndOlderPct2010`.

## Question 2: (1 part)  

**1)** Is `Age65AndOlderPct2010` a significant variable at .01 level in this analysis? Show the p-value. 
```{r}
fit1 <- lm(log_death_rate ~ Age65AndOlderPct2010, data = covid_county_sub)
summary(fit1)
```

**Response**: No, `Age65AndOlderPct2010` is not significant at the 0.01 level in this analysis.  The p-value is 0.96.

## 3.2 fit2: `Age` and `log_death_rate` controlling for `State`

## Question 3: (5 parts)

How do `Age65AndOlderPct2010` and `State` collectively affect `log_death_rate`. In `fit2`, run a linear model of `log_death_rate` vs `State` and `Age65AndOlderPct2010` (without interactions). 

```{r}
fit2 <- lm(log_death_rate ~ Age65AndOlderPct2010 + State, data = covid_county_sub)
summary(fit2)
```

**1)**  Is `Age65AndOlderPct2010` significant at .01 level in this model? 

**Response**: Yes, `Age65AndOlderPct2010` is significant at the 0.01 level in this model.  The p-value is 0.00021.

**2)** How to interpret the coefficient of `Age65AndOlderPct2010` over the `log_death_rate` in `fit2`?  How would you explain the difference in effects of `Age65AndOlderPct2010` in `fit1` vs `fit2`. (No more than 3 sentences).

**Response**: According to `fit2`, on average, a 1% increase in the percentage of people aged 65 and older increases the county's log death rate by 0.01343.  Notice that, in `fit1`, the coefficient on `Age65AndOlderPct2010` was not significant.  This is because we had not yet controlled for `State`.  Which state a county resides in has a significant effect on its log death rate.  Only once we control for these effects are we able to detect the statistically significant effect that `Age65AndOlderPct2010` has on log death rate (i.e. in `fit2`).  Further, `Age65AndOlderPct2010` could have a different effect on county log death rate depending on the state (and we could investigate these effects using interaction variables, but we won't in this midterm).  

**3)** Perform a test to see if  `State` is significant in this model at .01 level? 
```{r}
car::Anova(fit2)
```

**Response**: From the Anova output above, we can see that the F-statistic for `State` has a p-value of <2e-16 in this model.  Thus, we can reject the null hypothesis (which claims that the log death rate is the same among all states) at the 0.01 level.  Thus, we can conclude that the average log death rates are different among the states.  Thus, `State` is significant in this model at the 0.01 level.

**4)** Based on `fit2`, what is the estimated `log_death_rate` for a county in `NJ` and `AL` given `Age65AndOlderPct2010 = 20` respectively. Note that the base level of `State` is `AL`. **Show your formula and evaluate the final values. Do not use predict() in this question.**

    a) For NJ: `log_death_rate = `.
```{r}
-7.46913 + (0.01343*20) + 0.81708
```
    
    a) For AL: `log_death_rate = `. ##AL is the base
```{r}
-7.46913 + (0.01343*20)
```

**Response**: The estimated `log_death_rate` for the county in NJ is -6.38, and the stimated `log_death_rate` for the county in AL is -7.2.

**5)** Are the linear model assumptions reasonably met in `fit2`? Provide residual and normal plots for `fit2`. Use no more than three sentences summarizing your model diagnoses. 

```{r}
plot(fit2, 1:2)
```
**Response**: From our residual plot, we see that the residuals follow a relatively symmetric pattern with respect to the line residual = 0 in that we cannot discern any particular pattern of the residuals (satisfying linearity); additionally, the residuals seem relatively evenly distributed within a band (satisfying homoscedasticity).  From our Normal Q-Q plot, we can see that the observations are relatively symmetric about the line (satisfying normality).

## 3.3 fit.final

In this section, using all possible variables available in `covid_county_sub`, we will build a final parsimonious model and to identify a set of important variables that are related to the `log_death_rate`. We will not fine-tune the final model. 

As you have seen `State` effect explains a large portion of variability in `log_death_rate`, we will lock `State` in all the analyses. 

## Question 4: (5 parts)

**Important Remark:** You are going to run LASSO to pick up a few variables in addition to the `State`. In case you can't get LASSO to work go to **2)** directly and use the following set of variables to get your `fit.final`: State, PctEmpServices, PopDensity2010, Age65AndOlderPct2010, WhiteNonHispanicPct2010, HiCreativeClass2000. (Note: this is not necessarily the LASSO output.)

**1)**  Use LASSO to pick up a few variables in addition to `State`. List variables output from the above LASSO. 

To be specific let us control the following settings to get the same results. 

* Use set.seed(1) to control the cross-validation errors.
* Use 10-fold cross validations.
* Force `State` in all the LASSO models.
* Pick up the final set of variables using  `lambda.1se` 
```{r}
set.seed(1)
x_variables <- model.matrix(log_death_rate~., covid_county_sub)[,-1]
y_variable  <- covid_county_sub$log_death_rate
state_indicator <- c(rep(0, 48), rep(1, ncol(x_variables)-48))

model1 <- cv.glmnet(x_variables, y_variable, nfolds = 10, alpha = 1, penalty.factor = state_indicator)
plot(model1)

coef.min <- coef(model1, s="lambda.1se")
coef.min <- coef.min[which(coef.min !=0),][-1]
var.min <- rownames(as.matrix(coef.min))
state_indicator <- !(grepl("State", var.min))

lasso_sub <- covid_county_sub %>%
  select(log_death_rate, State, var.min[state_indicator])

model2_lasso <- lm(log_death_rate~.,lasso_sub)
summary(model2_lasso)
car::Anova(model2_lasso)
```

**Response**: As seen in the summary and Anova output above, the variables output from LASSO include the following: State, PctEmpAgriculture, PctEmpServices, PopDensity2010, Age65AndOlderPct2010, TotalPop25Plus, Ed3SomeCollegePct, Ed5CollegePlusPct, ForeignBornPct, NetMigrationRate1019, WhiteNonHispanicPct2010, and Type_2015_Update.  

**2)** Run a final model `fit.final` of `log_death_rate` vs `State` and the set of variables obtained from your LASSO output. Also include `Age65AndOlderPct2010` regardless whether it is in your LASSO output or not. (You can easily specify the lm() variables without any algorithm.)

Report the summary of `fit.final`. 

```{r}
fit.final <- lm(log_death_rate~.,lasso_sub)
summary(fit.final)
```

**3)** Is `State` significant at .01 level in this model? Is `Age65AndOlderPct2010` significant at .01 level in this model?
```{r}
car::Anova(fit.final)
```

**Response**: From the Anova output above, we can conclude that `State` is significant at 0.01 level, and `Age65AndOlderPct2010` is significant at the 0.01 level.  

**4)** Controlling for all other variables in `fit.final`, which state has the highest `log_death_rate` and what is the value?
```{r}
-6.34e+00 + 7.43e-01
```

**Response**: The state with the highest coefficient is New Jersey with a coefficient of 0.743.  Thus, once we take the intercept into account, the average log death rate in New Jersey counties is -5.6  

**5)** Assume all linear model assumptions are met. Write a brief summary of your findings based on `fit.final`. (No more than 4 lines after compiled)

**Response**: Because `State` is significant, we know that which state a county resides in matters when estimating a county's log death rate.  For example, being in the state of New Jersey increases a county's log death rate by 0.743 relative to Alabama on average.  Additionally, on average, a 1% increase in a the percentage of people aged 65 and older (`Age65AndOlderPct2010`) increases a county's log death rate by 0.0361.  We can look at the signs of the coefficients on the other significant covariates in the model to determine their impact on log death rates as well.  For example, an increase in population density (`PopDensity2010`) increases log death rates on average.  On the other hand, an increase in the percentage of the population with college educations (`Ed3SomeCollegePct` and `Ed5CollegePlusPct`) decreases log death rates on average.  

**End** of the case study!!!!