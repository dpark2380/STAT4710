---
title: "Midterm: COVID-19 Case Study"
author: "WRITE YOUR NAME HERE"
date: "March 31, 2025"
output:
  html_document:
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
    number_sections: no
  pdf_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
---

```{r Setup, include=FALSE, results='hide', warning=FALSE}
knitr::opts_chunk$set(echo = T, fig.width=8, fig.height=4)
options(scipen = 999, digits = 3)  # controls base R output

# Package setup
if(!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse, glmnet, coefplot, car, pROC, caret)
```

# Instruction

**All the teaching team members will be available from 7:00 - 9:15 PM. The submission will be closed sharp at 9:15PM.**


**Instruction:** This midterm requires the use of R. You are allowed to refer to lecture notes; however, any use of the internet or large language models (e.g. ChatGPT) is strictly prohibited. Write your answers using this .rmd file and knitr it into the html file. Show your codes, plots or R-output when needed. You always need to show your code with `echo = TRUE` which is the default setup for this file. If you have trouble formatting the plots, don't worry about it. We are not looking for pretty solutions, rather to see if you are able to make sense out of the data.  Make sure the compiled html (and/or pdf) file shows your answers completely and that they are not cut-off. Throughout the exam, you do not need to use any LaTeX or mathematical equations. **Whenever we ask for test at some significant level, assume all the model assumptions are satisfied.**

**All the answers should be clearly supported by relevant R code or based on the R output. There are many ways to provide answers.**  

There are 4 questions with various parts:

- **Question 1: 2 parts**
- **Question 2: 4 parts**
- **Question 3: 2 parts**
- **Question 4: 3 parts**


**DO NOT spend too much time on a single question. Come back to where you stuck after you have tried all the questions.**

**Files needed for the midterm:** 

- `any_folder/midterm.Rmd`
- `any_folder/midterm_25.csv`


**Electronic Submission:** Two files needed: your `.rmd` file and a compiled html file. If you have trouble submitting the files to Canvas, email them to lzhao@wharton.upenn.edu, dongwooo@wharton.upenn.edu and neil.fasching@asc.upenn.edu.

**Label them with your full name.** In the `Assignments` section, go to the `Midterm` assignment and upload your completed files.

**The submission folder will be closed sharp at 9:15PM**. 

**On Site Help:** We will answer any clarification questions. We may also help out with some minor code issues. We will, however, not provide any answers as to what functions to use for example. 

**Raise your hand** if you want to talk to one of us.
   
In case of emergency, here is Linda's cell: 6106590187 (text or call her)



# Background

The outbreak of the novel Corona virus disease 2019 (COVID-19) [was declared a public health emergency of international concern by the World Health Organization (WHO) on January 30, 2020](https://www.who.int/dg/speeches/detail/who-director-general-s-statement-on-ihr-emergency-committee-on-novel-coronavirus-(2019-ncov)). Upwards of [112 million cases have been confirmed worldwide, with nearly 2.5 million associated deaths](https://covid19.who.int/). Within the US alone, there have been [over 500,000 deaths and upwards of 28 million cases reported](https://covid.cdc.gov/covid-data-tracker/#trends_dailytrendscases). Governments around the world have implemented and suggested a number of policies to lessen the spread of the pandemic, including mask-wearing requirements, travel restrictions, business and school closures, and even stay-at-home orders. The global pandemic has impacted the lives of individuals in countless ways, and though many countries have begun vaccinating individuals, the long-term impact of the virus remains unclear.

The impact of COVID-19 on a given segment of the population appears to vary drastically based on the socioeconomic characteristics of the segment. In particular, differing rates of infection and fatalities have been reported among different [racial groups](https://www.cdc.gov/coronavirus/2019-ncov/covid-data/investigations-discovery/hospitalization-death-by-race-ethnicity.html), [age groups](https://www.cdc.gov/coronavirus/2019-ncov/covid-data/investigations-discovery/hospitalization-death-by-age.html), and [socioeconomic groups](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7221360/). One of the most important metrics for determining the impact of the pandemic is the death rate, which is the proportion of people within the total population that die due to the the disease. 


**There are two main goals for this case study.** 

1. We build a statistical model to explain variation in the COVID-19 fatality rate across U.S. counties using demographic and socioeconomic predictors. The model will help identify key factors associated with higher or lower fatality rates.

2. We define a binary outcome variable indicating whether a county has a high fatality rate, using a threshold of 2\%. We then construct a classification model to predict this outcome based on available covariates. The goal is to understand the characteristics of counties at high risk.





# Data preparation

In this case study, we have preprocessed the COVID-19 dataset with county-level and saved it as `midterm_25.csv`. We read the dataset into R and store it as `covid`, followed by displaying its structure.
```{r read data, message=FALSE, warning=FALSE}
## DO NOT MODIFY THIS CHUNK
covid <- read_csv("midterm_25.csv")
str(covid, give.attr = FALSE)
```

Most variable names are self-explanatory, but here are a few key variables to note:

- `log_fatality_rate`: The logarithm of the fatality rate on 02/20/2021, defined as:
\[ \texttt{fatality rate} = \frac{\texttt{(cumulative deaths until 02/20/2021)} + 1}{\texttt{(cumulative cases until 02/20/2021)} + 2} \] 
- `high_fatality`: 1 if fatality rate is higher than $2\%$ (or `log_fatality_rate` is higher than $-3.91$); otherwise, 0.
-  `State`: The two-letter abbreviation for each U.S. state in **Northeast region**.
-  `County`: The name of county
- `MedHHInc_10k`: Median household income in units of \$10,000.
-  `UnempRate2019`: The unemployment rate (%) in the year 2019.
-  `OwnHomePct`: The percentage of households that own their homes.
-  `Perpov_1980_0711`: A binary variable equal to 1 if the county is classified as a persistent poverty county, and 0 otherwise.
-  `HiAmenity`: A binary variable equal to 1 if the county is classified as having high natural amenities (e.g., climate, topography, lake, pond, ocean, water area, etc), and 0 otherwise.

**`midterm_25.csv` must be stored in the same directory of this Rmd file.** 

**`covid` will be used throughout the midterm.** 






# Question 1. EDA


## Question 1-1.

Print all states of the dataset in alphabetical order. How many states are included in the data? 

**Write your answer starting from here:**
```{r}

```






## Question 1-2

Display back to back boxplots of `log_fatality_rate` with respect to `State`.

**Write your answer starting from here:**
```{r}

```










# Question 2. Linear Model

In this question, we focus on the effect of economic factors (`MedHHInc_10k`, `UnempRate2019`, `OwnHomePct` and `Perpov_1980_0711`) over `log_fatality_rate`. 

## Question 2-1.

Build a multiple linear regression model for `log_fatality_rate` using the economic factors (`MedHHInc_10k`, `UnempRate2019`, `OwnHomePct`, `Perpov_1980_0711`) and `State` as predictors. 

a. Save the `lm` object as `fit_lm` and report the summary of `fit_lm`.
a. In this model, is `UnempRate2019` a significant variable at .01 level?
a. In this model, is `State` a significant variable at .01 level?
a. What is the effect of `MedHHInc_10k` on `log_fatality_rate`? Use no more than two sentences to interpret its effect.

**Write your answer starting from here:**

```{r}

```





## Question 2-2.

In the `fit_lm` model, display the top 3 states with the highest fatality rate on average, controlling the effects of all other variables.

**Write your answer starting from here:**



```{r}

```



## Question 2-3.

Using the `fit_lm` model from Question 2-1, predict the **log_fatality_rate** for a hypothetical county in Pennsylvania (PA) with the following characteristics: median household income of $100,000 (`MedHHInc_10k = 10`), unemployment rate of 5% (`UnempRate2019 = 5`), homeownership rate of 70% (`OwnHomePct = 70`), and not classified as a persistent poverty county (`Perpov_1980_0711 = 0`).

**Write your answer starting from here:**

```{r}
county <- tibble(MedHHInc_10k = 10, UnempRate2019 = 5,
                 OwnHomePct = 70, Perpov_1980_0711 = 0, State = "PA")

```



## Question 2-4. 

To check the model assumptions are met, draw the residual plot of residuals versus fitted values. Do you think the linear model assumptions are met? Why or why not?

**Write your answer starting from here:**

```{r}

```






# Question 3. LASSO

We would expand our model for `log_fatality_rate` to include more predictors.

## Question 3-1.

We will use LASSO to select a subset of predictors from the full set. Follow the steps below to complete the task and obtain the selected variables.

a. Run LASSO with cross-validation and save the resulting object as `fit_lasso_cv`.
    - Use `set.seed(20250331)` to control the cross-validation
    - Use 10-fold cross validations
    - Make sure all state indicators are forced into the LASSO model (i.e., not penalized)
a. Plot the mean squared error (MSE) as a function of the log penalty parameter $(\log\lambda)$. Report the value of the log penalty factor $(\log\lambda)$ which minimizes the cross-validated MSE.
a. Use the penalty `s = exp(-4)` for variable selection. Display the selected variables, including the forced-in variable `State`. (same as `lambda = exp(-4)`)
a. Collect the selected variable names including the force-in variable name `State` into a vector and save it as `lasso_selected`. Display the object `lasso_selected`.
   


You may use the predefined objects, `X`, `Y` and `force_in_indicator` for this question.
```{r}
## DO NOT MODIFY THIS CHUNK
set.seed(20250331)
Y <- as.matrix(covid[, 'log_fatality_rate']) # extract Y
X <- model.matrix(log_fatality_rate ~ ., data = select(covid, -c(high_fatality, County)))
force_in_indicator <- c(rep(0, 11), rep(1, ncol(X)-11))
```


**Write your answer starting from here:**
```{r}

```





## Question 3-2

For consistency, we assume that the following variables are selected by LASSO.

```{r}
## DO NOT MODIFY THIS CHUNK
lasso_selected <- c("State", "PctEmpConstruction", "PctEmpTrans", "PctEmpInformation",
                    "PctEmpAgriculture", "PopDensity2010", "Age65AndOlderPct2010", 
                    "TotalPop25Plus", "Under18Pct2010", "Ed5CollegePlusPct", 
                    "NaturalChangeRate1019", "UrbanInfluenceCode2013", 
                    "HiCreativeClass2000", "HiAmenity")
```



a. Build a multiple linear regression model for `log_fatality_rate` using all predictors in the vector `lasso_selected`. Save the `lm` object as `fit_lasso_relaxed` and report the summary of `fit_lasso_relaxed`.
a. In this model, is `HiAmenity` a significant variable at .05 level? Interpret the effect of `HiAmenity`.
a. In this model, is `State` a significant variable at .01 level?

**Write your answer starting from here:**
```{r}

```




# Question 4. Logistic Regression

We now turn our attention to the binary variable, `high_fatality`. Our goal is to build a classification model for `high_fatality`.

## Question 4-1.

We randomly split the dataset into training and test sets, assigning half of the counties in each state to the training set.
```{r}
## DO NOT MODIFY THIS CHUNK
set.seed(1111)
covid_train <- group_by(covid, State) %>% sample_frac(.5)
covid_test <- anti_join(covid, covid_train, by = c("State", "County"))
```

Build a logistic linear regression model for `high_fatality` using the economic factors (`MedHHInc_10k`, `UnempRate2019`, `OwnHomePct`, `Perpov_1980_0711`) as predictors. Remember to fit the model with train set (`covid_train`).

a. Save the `glm` object as `fit_logistic` and report the summary of `fit_logistic`.
a. In this model, is `UnempRate2019` a significant variable at .01 level?


**Write your answer starting from here:**

```{r}

```


## Question 4-2.

Using the `fit_logistic` model and a threshold of $0.5$, we may generate a classifier for `high_fatality`. 

a. Display its confusion matrix based on **the test set (`covid_test`)**.
a. Compute sensitivity and specificity.


**Write your answer starting from here:**

```{r}

```



## Question 4-3.

Display ROC curve of the `fit_logistic` model and compute AUC using the test set (`covid_test`). Use no more than two sentences to describe what does the ROC measure. 


**Write your answer starting from here:**

```{r}

```




















**===================== End of the Midterm =====================**

# Appendix {-}

## Data Summary {-}

The data comes from several different sources: 

1. [County-level infection and fatality data](https://github.com/nytimes/covid-19-data) - This dataset gives daily cumulative numbers on infection and fatality for each county. 
    * [NYC data](https://github.com/nychealth/coronavirus-data)
2. [County-level socioeconomic data](https://www.ers.usda.gov/data-products/atlas-of-rural-and-small-town-america/download-the-data/) - The following are the four relevant datasets from this site.   
    i. Income - Poverty level and household income. 
    ii. Jobs - Employment type, rate, and change.
    iii. People - Population size, density, education level, race, age, household size, and migration rates.
    iv. County Classifications - Type of county (rural or urban on a rural-urban continuum scale).
